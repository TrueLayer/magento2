import{Payment as e}from"truelayer-embedded-payment-page";function r(){const e=n();return e.style.position="fixed",e.style.bottom="0",e.style.left="0",e.style.right="0",e.style.top="100%",e.style.zIndex="9999",e}function n(){const e=document.createElement("iframe");return e.height="100%",e.width="100%",e}function o(e){e.style.top="0"}function a(e){e.style.top="100%"}function t({iframe:e,key:r,payload:n}){var o;null==(o=e.contentWindow)||o.postMessage(JSON.stringify({scope:"[TRUELAYER]",key:r,payload:n,date:Date.now()}),"*")}var c="0.6.7";function l({production:e}){return e?"https://app.truelayer.com":"https://app.truelayer-sandbox.com"}function i(e){const r=c;return e.searchParams.set("sdk_version",r),e}function s(e){const{production:r,url:n}=e;return i(new URL(`${l({production:r})}${n}`))}const u="tl-hpp-next";function _({hppUrl:e,iframe:r,production:n,iframeName:o,checkoutIframe:a}){t({iframe:a,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:o}});const c=s({production:n,url:e});return c.searchParams.set("iframe_name",o),r.src=c.toString(),r}const p="tl-checkout-widget";const d="tl-learn-more";const m=()=>{document.body.style.overflow="hidden"},O=()=>{document.body.style.overflow="auto"},E="tl-hpp-next-account-selection";const R="tl-error-snackbar";var f=Object.defineProperty,y=Object.defineProperties,C=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertySymbols,N=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable,L=(e,r,n)=>r in e?f(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,h=(e,r)=>{for(var n in r||(r={}))N.call(r,n)&&L(e,n,r[n]);if(A)for(var n of A(r))P.call(r,n)&&L(e,n,r[n]);return e};function k(c){var i,f=c,{onDone:L,onCancel:k,onError:D,onExpired:S,onPayButtonClicked:I,onNavigation:b}=f,M=((e,r)=>{var n={};for(var o in e)N.call(e,o)&&r.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&A)for(var o of A(e))r.indexOf(o)<0&&P.call(e,o)&&(n[o]=e[o]);return n})(f,["onDone","onCancel","onError","onExpired","onPayButtonClicked","onNavigation"]);let U,T=null,v=null,g=null,G=null,K=null,F=null,w=!1;const x={isLearnMoreReady:!1},H=null!=(i=M.production)&&i;function B(n){var c,i,p,f,y,C;if(n.origin===l({production:H})&&n.data)try{let l;try{l=JSON.parse(n.data)}catch(e){}if("[TRUELAYER]"!==l.scope)return;switch(null==l?void 0:l.key){case"FROM_CHECKOUT_PAGE_PRERENDER_HPP_URL":const n=l.payload.hppUrl;g||(g=function({container:e,hppUrl:n,production:o,iframeName:a}){const t=r();t.title="TrueLayer Payment",t.id=u,t.name=u;const c=s({production:o,url:n});return c.searchParams.set("iframe_name",a),t.src=c.toString(),e&&e.appendChild(t),t}({container:T,hppUrl:n,production:H,iframeName:"hpp"}));break;case"FROM_CHECKOUT_PAGE_ON_PAY_BUTTON_CLICKED":m(),null==I||I(),g&&(o(g),t({iframe:g,key:"FROM_SDK_PAGE_OPEN_HPP_URL"}));break;case"FROM_CHECKOUT_PAGE_ON_EPP_PAY_BUTTON_CLICKED":m(),null==I||I();const{payment_id:A,resource_token:N,return_uri:P}=l.payload;e({payment_id:A,resource_token:N,open_bank_in_new_tab:!0,return_uri:P,production:H,onAbort:k,onDone:(e,r)=>{null==L||L({resultStatus:null!=r?r:"pending"})},onError(e){null==D||D(e)},extra_hash_params:{is_web_sdk_fallback:!0}}).start();break;case"FROM_CHECKOUT_PAGE_PRERENDER_LEARN_MORE":const h=l.payload.learnMoreUrl;K||(K=function({container:e,learnMoreUrl:n,production:o}){const a=r();a.title="TrueLayer Learn More",a.id=d,a.name=d;const t=s({production:o,url:n});return a.src=t.toString(),e&&e.appendChild(a),a}({container:T,learnMoreUrl:h,production:H}));break;case"FROM_CHECKOUT_PAGE_PRERENDER_ACCOUNT_SELECTION":const M=l.payload.accountSelectionUrl;G||(G=function({container:e,accountSelectionUrl:n,production:o}){const a=r();a.title="TrueLayer Account Selection",a.id=E,a.name=E;const t=s({production:o,url:n});return t.searchParams.set("iframe_name","account-selection"),a.src=t.toString(),e&&e.appendChild(a),a}({container:T,accountSelectionUrl:M,production:H}));break;case"FROM_CHECKOUT_PAGE_PRERENDER_ERROR_SNACKBAR":const U=l.payload.errorUrl;F||(F=function({container:e,errorUrl:n,production:o}){const a=r();a.title="TrueLayer Error",a.id=R,a.name=R;const t=s({production:o,url:n});return t.searchParams.set("iframe_name","error"),a.src=t.toString(),e&&e.appendChild(a),a}({container:T,errorUrl:U,production:H}));break;case"FROM_CHECKOUT_PAGE_ON_PAY_BUTTON_ERROR_CLICKED":if(null==I||I(),F){o(F);const e=new Error("Cannot initialise web sdk");null==D||D(e),t({iframe:F,key:"FROM_SDK_OPEN_ERROR_SNACKBAR"})}break;case"FROM_ERROR_SNACKBAR_ERROR_SNACKBAR_DISAPPEARED":case"FROM_ERROR_SNACKBAR_ON_CLOSE_ICON_CLICKED":v&&t({iframe:v,key:null==l?void 0:l.key}),F&&a(F),O();break;case"FROM_CHECKOUT_PAGE_LEARN_MORE_BUTTON_CLICKED":m(),K&&(o(K),t({iframe:K,key:"FROM_SDK_OPEN_LEARN_MORE"}));break;case"FROM_CHECKOUT_PAGE_ACCOUNT_SELECTION_BUTTON_CLICKED":m(),G&&(o(G),t({iframe:G,key:"FROM_SDK_OPEN_ACCOUNT_SELECTION"}));break;case"FROM_CHECKOUT_PAGE_NAVIGATE_TO_PAGE":null==b||b(l.payload.page);break;case"FROM_DIALOG_PAGE_CLOSE_LEARN_MORE":K&&a(K),O();break;case"FROM_DIALOG_PAGE_CLOSE_ACCOUNT_SELECTION":{const e=null==(c=l.payload)?void 0:c.hppUrl;G&&a(G),g&&(a(g),e&&v&&_({iframe:g,hppUrl:e,production:H,iframeName:"hpp",checkoutIframe:v})),O();break}case"FROM_DIALOG_PAGE_ON_DONE":const B=l.payload.resultStatus;O(),null==L||L({resultStatus:B}),null==g||g.remove(),null==G||G.remove(),null==K||K.remove(),null==v||v.remove(),null==F||F.remove();break;case"FROM_DIALOG_PAGE_ON_CANCEL":{if(v){const e=new URL(v.src);e.searchParams.set("reloaded","true"),v.src=e.toString()}const e=null==(i=l.payload)?void 0:i.hppUrl,r=null==(p=l.payload)?void 0:p.accountSelectionUrl;G&&(a(G),r&&v&&_({iframe:G,hppUrl:r,production:H,iframeName:"account-selection",checkoutIframe:v}),void 0===r&&G.remove()),g&&(a(g),e&&v&&_({iframe:g,hppUrl:e,production:H,iframeName:"hpp",checkoutIframe:v})),O(),null==k||k();break}case"FROM_DIALOG_ON_ERROR":const Y=null==(f=l.payload)?void 0:f.error,j=new Error(Y.message);j.name=Y.type,null==D||D(j);break;case"FROM_DIALOG_ON_EXPIRED":w||(null==S||S(),w=!0);break;case"FROM_DIALOG_REDIRECT_TO_PROVIDER":const W=l.payload.bankUri,z=window.open(W,"_blank");null==z||z.focus();break;case"FROM_DIALOG_IS_READY":"learn-more"===(null==(y=l.payload)?void 0:y.iframeName)&&(x.isLearnMoreReady=!0),v&&t({iframe:v,key:"FROM_SDK_DIALOG_IS_READY",payload:{iframeName:null==(C=l.payload)?void 0:C.iframeName}});break;case"FROM_DIALOG_WILL_CLOSE":v&&(t({iframe:v,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:"hpp"}}),t({iframe:v,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:"account-selection"}}))}}catch(e){console.error(e)}}const Y=e=>{const r=r=>({iframe:r,key:"FROM_SDK_TOKEN_EXPIRED",payload:{payment_id:e}});v?t(r(v)):(g&&t(r(g)),G&&t(r(G)))},j=e=>{var r;let n;v&&function({paymentId:e,resourceToken:r,checkoutIframe:n}){const o=new URL(n.src);o.searchParams.append("payment_id",e),o.searchParams.append("resource_token",r),n.src=o.toString()}((r=h({},e),y(r,C({checkoutIframe:v}))));try{n=function(e){const r=JSON.parse(atob(e.split(".")[1]));return new Date(1e3*r.exp)}(e.resourceToken)}catch(e){console.log("onExpire - Error getting expiration time"),console.error(e)}if(n){const r=n.getTime()-Date.now();r>0?U=window.setTimeout((()=>{Y(e.paymentId)}),r):Y(e.paymentId)}return{cleanup:W}},W=()=>{window.removeEventListener("message",B),clearTimeout(U)};return{mount:e=>(T=e,v=function({container:e,uiSettings:r,production:o,maxWaitForResult:a}){var t;e&&(e.innerHTML="");const c=n();c.title="TrueLayer WebSDK",c.id=p,c.name=p;const l=s({production:o,url:"/embedded/checkout"});return(null==r?void 0:r.recommendedPaymentMethod)&&l.searchParams.set("recommended","true"),void 0!==(null==r?void 0:r.borderRadius)&&l.searchParams.set("borderRadius",String(r.borderRadius)),l.searchParams.set("size",null!=(t=null==r?void 0:r.size)?t:"large"),(null==r?void 0:r.merchantLogoUri)&&l.searchParams.set("merchant_logo_uri",r.merchantLogoUri),(null==r?void 0:r.lng)&&l.searchParams.set("lng",r.lng),a&&l.searchParams.set("max_wait_for_result",String(a)),c.src=l.toString(),e&&e.appendChild(c),c}(h({container:e,production:H},M)),window.addEventListener("message",B),{start:j,cleanup:W}),start:j,cleanup:W,openLearnMoreModal:()=>{function e(){r&&clearInterval(r),K&&(o(K),t({iframe:K,key:"FROM_SDK_OPEN_LEARN_MORE"}))}let r=null;x.isLearnMoreReady?e():r=setInterval((()=>{x.isLearnMoreReady&&e()}),100)}}}export{k as initWebSdk};
