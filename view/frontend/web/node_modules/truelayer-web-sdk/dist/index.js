import{Payment as e}from"truelayer-embedded-payment-page";function r(){const e=n();return e.style.position="fixed",e.style.bottom="0",e.style.left="0",e.style.right="0",e.style.zIndex="9999",e.style.pointerEvents="none",e}function n(){const e=document.createElement("iframe");return e.height="100%",e.width="100%",e}function o(e){e.style.pointerEvents="auto"}function a(e){e.style.pointerEvents="none"}function t({iframe:e,key:r,payload:n}){var o;null==(o=e.contentWindow)||o.postMessage(JSON.stringify({scope:"[TRUELAYER]",key:r,payload:n,date:Date.now()}),"*")}var c="0.6.4";function l({production:e}){return e?"https://app.truelayer.com":"https://app.truelayer-sandbox.com"}function i(e){const r=c;return e.searchParams.set("sdk_version",r),e}function s(e){const{production:r,url:n}=e;return i(new URL(`${l({production:r})}${n}`))}const u="tl-hpp-next";function _({hppUrl:e,iframe:r,production:n,iframeName:o,checkoutIframe:a}){t({iframe:a,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:o}});const c=s({production:n,url:e});return c.searchParams.set("iframe_name",o),r.src=c.toString(),r}const d="tl-checkout-widget";const p="tl-learn-more";const m=()=>{document.body.style.overflow="hidden"},E=()=>{document.body.style.overflow="auto"},O="tl-hpp-next-account-selection";const R="tl-error-snackbar";var f=Object.defineProperty,y=Object.defineProperties,C=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertySymbols,P=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable,h=(e,r,n)=>r in e?f(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,L=(e,r)=>{for(var n in r||(r={}))P.call(r,n)&&h(e,n,r[n]);if(A)for(var n of A(r))N.call(r,n)&&h(e,n,r[n]);return e};function k(c){var i,f=c,{onDone:h,onCancel:k,onError:U,onPayButtonClicked:b,onNavigation:v}=f,S=((e,r)=>{var n={};for(var o in e)P.call(e,o)&&r.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&A)for(var o of A(e))r.indexOf(o)<0&&N.call(e,o)&&(n[o]=e[o]);return n})(f,["onDone","onCancel","onError","onPayButtonClicked","onNavigation"]);let M=null,T=null,D=null,I=null,g=null,K=null;const F={isLearnMoreReady:!1},G=null!=(i=S.production)&&i;function w(n){var c,i,d,f,y,C;if(n.origin===l({production:G})&&n.data)try{let l;try{l=JSON.parse(n.data)}catch(e){}if("[TRUELAYER]"!==l.scope)return;switch(null==l?void 0:l.key){case"FROM_CHECKOUT_PAGE_PRERENDER_HPP_URL":const n=l.payload.hppUrl;D||(D=function({container:e,hppUrl:n,production:o,iframeName:a}){const t=r();t.title="TrueLayer Payment",t.id=u,t.name=u;const c=s({production:o,url:n});return c.searchParams.set("iframe_name",a),t.src=c.toString(),e&&e.appendChild(t),t}({container:M,hppUrl:n,production:G,iframeName:"hpp"}));break;case"FROM_CHECKOUT_PAGE_ON_PAY_BUTTON_CLICKED":m(),null==b||b(),D&&(o(D),t({iframe:D,key:"FROM_SDK_PAGE_OPEN_HPP_URL"}));break;case"FROM_CHECKOUT_PAGE_ON_EPP_PAY_BUTTON_CLICKED":m(),null==b||b();const{payment_id:A,resource_token:P,return_uri:N}=l.payload;e({payment_id:A,resource_token:P,open_bank_in_new_tab:!0,return_uri:N,production:G,onAbort:k,onDone:()=>{null==h||h({resultStatus:"success"})},onError(e){null==U||U(e)},extra_hash_params:{is_web_sdk_fallback:!0}}).start();break;case"FROM_CHECKOUT_PAGE_PRERENDER_LEARN_MORE":const L=l.payload.learnMoreUrl;g||(g=function({container:e,learnMoreUrl:n,production:o}){const a=r();a.title="TrueLayer Learn More",a.id=p,a.name=p;const t=s({production:o,url:n});return a.src=t.toString(),e&&e.appendChild(a),a}({container:M,learnMoreUrl:L,production:G}));break;case"FROM_CHECKOUT_PAGE_PRERENDER_ACCOUNT_SELECTION":const S=l.payload.accountSelectionUrl;I||(I=function({container:e,accountSelectionUrl:n,production:o}){const a=r();a.title="TrueLayer Account Selection",a.id=O,a.name=O;const t=s({production:o,url:n});return t.searchParams.set("iframe_name","account-selection"),a.src=t.toString(),e&&e.appendChild(a),a}({container:M,accountSelectionUrl:S,production:G}));break;case"FROM_CHECKOUT_PAGE_PRERENDER_ERROR_SNACKBAR":const w=l.payload.errorUrl;K||(K=function({container:e,errorUrl:n,production:o}){const a=r();a.title="TrueLayer Error",a.id=R,a.name=R;const t=s({production:o,url:n});return t.searchParams.set("iframe_name","error"),a.src=t.toString(),e&&e.appendChild(a),a}({container:M,errorUrl:w,production:G}));break;case"FROM_CHECKOUT_PAGE_ON_PAY_BUTTON_ERROR_CLICKED":if(null==b||b(),K){o(K);const e=new Error("Cannot initialise web sdk");null==U||U(e),t({iframe:K,key:"FROM_SDK_OPEN_ERROR_SNACKBAR"})}break;case"FROM_ERROR_SNACKBAR_ERROR_SNACKBAR_DISAPPEARED":case"FROM_ERROR_SNACKBAR_ON_CLOSE_ICON_CLICKED":T&&t({iframe:T,key:null==l?void 0:l.key}),K&&a(K),E();break;case"FROM_CHECKOUT_PAGE_LEARN_MORE_BUTTON_CLICKED":m(),g&&(o(g),t({iframe:g,key:"FROM_SDK_OPEN_LEARN_MORE"}));break;case"FROM_CHECKOUT_PAGE_ACCOUNT_SELECTION_BUTTON_CLICKED":m(),I&&(o(I),t({iframe:I,key:"FROM_SDK_OPEN_ACCOUNT_SELECTION"}));break;case"FROM_CHECKOUT_PAGE_NAVIGATE_TO_PAGE":null==v||v(l.payload.page);break;case"FROM_DIALOG_PAGE_CLOSE_LEARN_MORE":g&&a(g),E();break;case"FROM_DIALOG_PAGE_CLOSE_ACCOUNT_SELECTION":{const e=null==(c=l.payload)?void 0:c.hppUrl;I&&a(I),D&&(a(D),e&&T&&_({iframe:D,hppUrl:e,production:G,iframeName:"hpp",checkoutIframe:T})),E();break}case"FROM_DIALOG_PAGE_ON_DONE":const H=l.payload.resultStatus;E(),null==h||h({resultStatus:H}),null==D||D.remove(),null==I||I.remove(),null==g||g.remove(),null==T||T.remove(),null==K||K.remove();break;case"FROM_DIALOG_PAGE_ON_CANCEL":{if(T){const e=new URL(T.src);e.searchParams.set("reloaded","true"),T.src=e.toString()}const e=null==(i=l.payload)?void 0:i.hppUrl,r=null==(d=l.payload)?void 0:d.accountSelectionUrl;I&&(a(I),r&&T&&_({iframe:I,hppUrl:r,production:G,iframeName:"account-selection",checkoutIframe:T}),void 0===r&&I.remove()),D&&(a(D),e&&T&&_({iframe:D,hppUrl:e,production:G,iframeName:"hpp",checkoutIframe:T})),E(),null==k||k();break}case"FROM_DIALOG_ON_ERROR":const B=null==(f=l.payload)?void 0:f.error,x=new Error(B.message);x.name=B.type,null==U||U(x);break;case"FROM_DIALOG_REDIRECT_TO_PROVIDER":const Y=l.payload.bankUri,j=window.open(Y,"_blank");null==j||j.focus();break;case"FROM_DIALOG_IS_READY":"learn-more"===(null==(y=l.payload)?void 0:y.iframeName)&&(F.isLearnMoreReady=!0),T&&t({iframe:T,key:"FROM_SDK_DIALOG_IS_READY",payload:{iframeName:null==(C=l.payload)?void 0:C.iframeName}})}}catch(e){console.error(e)}}const H=e=>{var r;return T&&function({paymentId:e,resourceToken:r,checkoutIframe:n}){const o=new URL(n.src);o.searchParams.append("payment_id",e),o.searchParams.append("resource_token",r),n.src=o.toString()}((r=L({},e),y(r,C({checkoutIframe:T})))),{cleanup:B}},B=()=>window.removeEventListener("message",w);return{mount:e=>(M=e,T=function({container:e,uiSettings:r,production:o,maxWaitForResult:a}){var t;e&&(e.innerHTML="");const c=n();c.title="TrueLayer WebSDK",c.id=d,c.name=d;const l=s({production:o,url:"/embedded/checkout"});return(null==r?void 0:r.recommendedPaymentMethod)&&l.searchParams.set("recommended","true"),void 0!==(null==r?void 0:r.borderRadius)&&l.searchParams.set("borderRadius",String(r.borderRadius)),l.searchParams.set("size",null!=(t=null==r?void 0:r.size)?t:"large"),(null==r?void 0:r.merchantLogoUri)&&l.searchParams.set("merchant_logo_uri",r.merchantLogoUri),a&&l.searchParams.set("max_wait_for_result",String(a)),c.src=l.toString(),e&&e.appendChild(c),c}(L({container:e,production:G},S)),window.addEventListener("message",w),{start:H,cleanup:B}),start:H,cleanup:B,openLearnMoreModal:()=>{function e(){r&&clearInterval(r),g&&(o(g),t({iframe:g,key:"FROM_SDK_OPEN_LEARN_MORE"}))}let r=null;F.isLearnMoreReady?e():r=setInterval((()=>{F.isLearnMoreReady&&e()}),100)}}}export{k as initWebSdk};
