!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("truelayer-embedded-payment-page")):"function"==typeof define&&define.amd?define(["exports","truelayer-embedded-payment-page"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).TrueLayer={},e.truelayerEmbeddedPaymentPage)}(this,(function(e,r){"use strict";function n(){const e=o();return e.style.position="fixed",e.style.bottom="0",e.style.left="0",e.style.right="0",e.style.top="100%",e.style.zIndex="9999",e}function o(){const e=document.createElement("iframe");return e.height="100%",e.width="100%",e}function a(e){e.style.top="0"}function t(e){e.style.top="100%"}function c({iframe:e,key:r,payload:n}){var o;null==(o=e.contentWindow)||o.postMessage(JSON.stringify({scope:"[TRUELAYER]",key:r,payload:n,date:Date.now()}),"*")}var i="0.6.7";function l({production:e}){return e?"https://app.truelayer.com":"https://app.truelayer-sandbox.com"}function s(e){const r=i;return e.searchParams.set("sdk_version",r),e}function u(e){const{production:r,url:n}=e;return s(new URL(`${l({production:r})}${n}`))}const _="tl-hpp-next";function d({hppUrl:e,iframe:r,production:n,iframeName:o,checkoutIframe:a}){c({iframe:a,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:o}});const t=u({production:n,url:e});return t.searchParams.set("iframe_name",o),r.src=t.toString(),r}const p="tl-checkout-widget";const m="tl-learn-more";const O=()=>{document.body.style.overflow="hidden"},E=()=>{document.body.style.overflow="auto"},R="tl-hpp-next-account-selection";const f="tl-error-snackbar";var y=Object.defineProperty,C=Object.defineProperties,P=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertySymbols,N=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,L=(e,r,n)=>r in e?y(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,k=(e,r)=>{for(var n in r||(r={}))N.call(r,n)&&L(e,n,r[n]);if(A)for(var n of A(r))h.call(r,n)&&L(e,n,r[n]);return e};e.initWebSdk=function(e){var i,s=e,{onDone:y,onCancel:L,onError:b,onExpired:S,onPayButtonClicked:D,onNavigation:I}=s,M=((e,r)=>{var n={};for(var o in e)N.call(e,o)&&r.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&A)for(var o of A(e))r.indexOf(o)<0&&h.call(e,o)&&(n[o]=e[o]);return n})(s,["onDone","onCancel","onError","onExpired","onPayButtonClicked","onNavigation"]);let T,U=null,v=null,g=null,G=null,K=null,F=null,w=!1;const x={isLearnMoreReady:!1},H=null!=(i=M.production)&&i;function B(e){var o,i,s,p,C,P;if(e.origin===l({production:H})&&e.data)try{let l;try{l=JSON.parse(e.data)}catch(e){}if("[TRUELAYER]"!==l.scope)return;switch(null==l?void 0:l.key){case"FROM_CHECKOUT_PAGE_PRERENDER_HPP_URL":const e=l.payload.hppUrl;g||(g=function({container:e,hppUrl:r,production:o,iframeName:a}){const t=n();t.title="TrueLayer Payment",t.id=_,t.name=_;const c=u({production:o,url:r});return c.searchParams.set("iframe_name",a),t.src=c.toString(),e&&e.appendChild(t),t}({container:U,hppUrl:e,production:H,iframeName:"hpp"}));break;case"FROM_CHECKOUT_PAGE_ON_PAY_BUTTON_CLICKED":O(),null==D||D(),g&&(a(g),c({iframe:g,key:"FROM_SDK_PAGE_OPEN_HPP_URL"}));break;case"FROM_CHECKOUT_PAGE_ON_EPP_PAY_BUTTON_CLICKED":O(),null==D||D();const{payment_id:A,resource_token:N,return_uri:h}=l.payload;r.Payment({payment_id:A,resource_token:N,open_bank_in_new_tab:!0,return_uri:h,production:H,onAbort:L,onDone:(e,r)=>{null==y||y({resultStatus:null!=r?r:"pending"})},onError(e){null==b||b(e)},extra_hash_params:{is_web_sdk_fallback:!0}}).start();break;case"FROM_CHECKOUT_PAGE_PRERENDER_LEARN_MORE":const k=l.payload.learnMoreUrl;K||(K=function({container:e,learnMoreUrl:r,production:o}){const a=n();a.title="TrueLayer Learn More",a.id=m,a.name=m;const t=u({production:o,url:r});return a.src=t.toString(),e&&e.appendChild(a),a}({container:U,learnMoreUrl:k,production:H}));break;case"FROM_CHECKOUT_PAGE_PRERENDER_ACCOUNT_SELECTION":const M=l.payload.accountSelectionUrl;G||(G=function({container:e,accountSelectionUrl:r,production:o}){const a=n();a.title="TrueLayer Account Selection",a.id=R,a.name=R;const t=u({production:o,url:r});return t.searchParams.set("iframe_name","account-selection"),a.src=t.toString(),e&&e.appendChild(a),a}({container:U,accountSelectionUrl:M,production:H}));break;case"FROM_CHECKOUT_PAGE_PRERENDER_ERROR_SNACKBAR":const T=l.payload.errorUrl;F||(F=function({container:e,errorUrl:r,production:o}){const a=n();a.title="TrueLayer Error",a.id=f,a.name=f;const t=u({production:o,url:r});return t.searchParams.set("iframe_name","error"),a.src=t.toString(),e&&e.appendChild(a),a}({container:U,errorUrl:T,production:H}));break;case"FROM_CHECKOUT_PAGE_ON_PAY_BUTTON_ERROR_CLICKED":if(null==D||D(),F){a(F);const e=new Error("Cannot initialise web sdk");null==b||b(e),c({iframe:F,key:"FROM_SDK_OPEN_ERROR_SNACKBAR"})}break;case"FROM_ERROR_SNACKBAR_ERROR_SNACKBAR_DISAPPEARED":case"FROM_ERROR_SNACKBAR_ON_CLOSE_ICON_CLICKED":v&&c({iframe:v,key:null==l?void 0:l.key}),F&&t(F),E();break;case"FROM_CHECKOUT_PAGE_LEARN_MORE_BUTTON_CLICKED":O(),K&&(a(K),c({iframe:K,key:"FROM_SDK_OPEN_LEARN_MORE"}));break;case"FROM_CHECKOUT_PAGE_ACCOUNT_SELECTION_BUTTON_CLICKED":O(),G&&(a(G),c({iframe:G,key:"FROM_SDK_OPEN_ACCOUNT_SELECTION"}));break;case"FROM_CHECKOUT_PAGE_NAVIGATE_TO_PAGE":null==I||I(l.payload.page);break;case"FROM_DIALOG_PAGE_CLOSE_LEARN_MORE":K&&t(K),E();break;case"FROM_DIALOG_PAGE_CLOSE_ACCOUNT_SELECTION":{const e=null==(o=l.payload)?void 0:o.hppUrl;G&&t(G),g&&(t(g),e&&v&&d({iframe:g,hppUrl:e,production:H,iframeName:"hpp",checkoutIframe:v})),E();break}case"FROM_DIALOG_PAGE_ON_DONE":const B=l.payload.resultStatus;E(),null==y||y({resultStatus:B}),null==g||g.remove(),null==G||G.remove(),null==K||K.remove(),null==v||v.remove(),null==F||F.remove();break;case"FROM_DIALOG_PAGE_ON_CANCEL":{if(v){const e=new URL(v.src);e.searchParams.set("reloaded","true"),v.src=e.toString()}const e=null==(i=l.payload)?void 0:i.hppUrl,r=null==(s=l.payload)?void 0:s.accountSelectionUrl;G&&(t(G),r&&v&&d({iframe:G,hppUrl:r,production:H,iframeName:"account-selection",checkoutIframe:v}),void 0===r&&G.remove()),g&&(t(g),e&&v&&d({iframe:g,hppUrl:e,production:H,iframeName:"hpp",checkoutIframe:v})),E(),null==L||L();break}case"FROM_DIALOG_ON_ERROR":const j=null==(p=l.payload)?void 0:p.error,Y=new Error(j.message);Y.name=j.type,null==b||b(Y);break;case"FROM_DIALOG_ON_EXPIRED":w||(null==S||S(),w=!0);break;case"FROM_DIALOG_REDIRECT_TO_PROVIDER":const W=l.payload.bankUri,z=window.open(W,"_blank");null==z||z.focus();break;case"FROM_DIALOG_IS_READY":"learn-more"===(null==(C=l.payload)?void 0:C.iframeName)&&(x.isLearnMoreReady=!0),v&&c({iframe:v,key:"FROM_SDK_DIALOG_IS_READY",payload:{iframeName:null==(P=l.payload)?void 0:P.iframeName}});break;case"FROM_DIALOG_WILL_CLOSE":v&&(c({iframe:v,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:"hpp"}}),c({iframe:v,key:"FROM_SDK_DIALOG_IS_RELOADING",payload:{iframeName:"account-selection"}}))}}catch(e){console.error(e)}}const j=e=>{const r=r=>({iframe:r,key:"FROM_SDK_TOKEN_EXPIRED",payload:{payment_id:e}});v?c(r(v)):(g&&c(r(g)),G&&c(r(G)))},Y=e=>{var r;let n;v&&function({paymentId:e,resourceToken:r,checkoutIframe:n}){const o=new URL(n.src);o.searchParams.append("payment_id",e),o.searchParams.append("resource_token",r),n.src=o.toString()}((r=k({},e),C(r,P({checkoutIframe:v}))));try{n=function(e){const r=JSON.parse(atob(e.split(".")[1]));return new Date(1e3*r.exp)}(e.resourceToken)}catch(e){console.log("onExpire - Error getting expiration time"),console.error(e)}if(n){const r=n.getTime()-Date.now();r>0?T=window.setTimeout((()=>{j(e.paymentId)}),r):j(e.paymentId)}return{cleanup:W}},W=()=>{window.removeEventListener("message",B),clearTimeout(T)};return{mount:e=>(U=e,v=function({container:e,uiSettings:r,production:n,maxWaitForResult:a}){var t;e&&(e.innerHTML="");const c=o();c.title="TrueLayer WebSDK",c.id=p,c.name=p;const i=u({production:n,url:"/embedded/checkout"});return(null==r?void 0:r.recommendedPaymentMethod)&&i.searchParams.set("recommended","true"),void 0!==(null==r?void 0:r.borderRadius)&&i.searchParams.set("borderRadius",String(r.borderRadius)),i.searchParams.set("size",null!=(t=null==r?void 0:r.size)?t:"large"),(null==r?void 0:r.merchantLogoUri)&&i.searchParams.set("merchant_logo_uri",r.merchantLogoUri),(null==r?void 0:r.lng)&&i.searchParams.set("lng",r.lng),a&&i.searchParams.set("max_wait_for_result",String(a)),c.src=i.toString(),e&&e.appendChild(c),c}(k({container:e,production:H},M)),window.addEventListener("message",B),{start:Y,cleanup:W}),start:Y,cleanup:W,openLearnMoreModal:()=>{function e(){r&&clearInterval(r),K&&(a(K),c({iframe:K,key:"FROM_SDK_OPEN_LEARN_MORE"}))}let r=null;x.isLearnMoreReady?e():r=setInterval((()=>{x.isLearnMoreReady&&e()}),100)}}},Object.defineProperty(e,"__esModule",{value:!0})}));
