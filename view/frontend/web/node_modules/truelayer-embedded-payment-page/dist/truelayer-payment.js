!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Truelayer={})}(this,(function(e){"use strict";var t=Object.defineProperty,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,r=(e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i,s=(e,t,n)=>(r(e,"symbol"!=typeof t?t+"":t,n),n);class a{constructor(e,t,a){s(this,"config"),s(this,"environment"),s(this,"logger"),s(this,"iframe"),s(this,"getIframe",(()=>this.iframe||this.createIframe())),s(this,"createIframe",(()=>(this.iframe=document.createElement("iframe"),this.iframe.src=this.getUrl(),this.iframe.title="Hosted payment page - EPP",this.iframe.style.border="none",this.iframe.style.boxSizing="border-box",this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.minWidth=this.environment.minWidth,this.iframe.style.minHeight=this.environment.minHeight,this.logger.log("created HPP iframe:",this.iframe.src),this.iframe))),s(this,"attachIframe",(e=>{e.appendChild(this.getIframe()),this.logger.log("attached HPP iframe to:",e)})),s(this,"getUrl",(()=>{var e;const t=new URLSearchParams({lng:this.getLanguage()}),s=((e,t)=>{for(var s in t||(t={}))i.call(t,s)&&r(e,s,t[s]);if(n)for(var s of n(t))o.call(t,s)&&r(e,s,t[s]);return e})({"web-sdk":this.environment.version,signup:String(null!=(e=this.config.signup)&&e),open_bank_in_new_tab:String(!0===this.config.open_bank_in_new_tab),hide_navigation:String(!0===this.config.hide_navigation),max_wait_for_result:this.config.max_wait_for_result,[`${this.config.type}_id`]:this.getResourceId(),resource_token:this.config.resource_token,return_uri:this.config.return_uri,merchant_logo_uri:this.config.merchant_logo_uri},this.config.extra_hash_params),a=JSON.parse(JSON.stringify(s,((e,t)=>null===t||""===t?void 0:t))),l=new URLSearchParams(a),h=new URL(this.getResourcePath(),this.environment.hppUrl);return h.search=t.toString(),h.hash=l.toString(),h.toString()})),s(this,"getResourceId",(()=>{switch(this.config.type){case"payment":return this.config.payment_id;case"mandate":return this.config.mandate_id;default:return""}})),s(this,"getLanguage",(()=>{if(this.config.language){if(!/^[a-z]{2}$/i.test(this.config.language))throw new Error("Language passed in the wrong format. Accepted ISO 2 Letter Language Codes");return this.config.language}return""})),s(this,"getResourcePath",(()=>`${"mandate"===this.config.type?"/mandates":"/payments"}${this.environment.mock?"-mock":""}`)),s(this,"setConfig",(e=>{if("payment"===e.type&&!e.payment_id)throw new Error("payment_id is required");if("mandate"===e.type&&!e.mandate_id)throw new Error("mandate_id is required");if(!e.resource_token)throw new Error("resource_token is required");if(!e.return_uri)throw new Error("return_uri is required");this.config=e})),this.setConfig(t),this.environment=e,this.logger=a}}const l="600px",h="750px",d="320px",c="320px";var g=Object.defineProperty,m=(e,t,n)=>(((e,t,n)=>{t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class u{constructor(e,t){m(this,"environment"),m(this,"logger"),m(this,"modalElement"),m(this,"modalContent"),m(this,"createModalElement",(()=>{const e=document.createElement("div");return e.id="truelayer-modal",e.style.cssText="\n      box-sizing: border-box;\n      position: fixed;\n      display: flex;\n      z-index: 9999;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      margin: auto;\n      background-color: rgb(0,0,0);\n      background-color: rgba(0,0,0,0.6);\n      opacity: 0;\n      transition: all 0.5s ease-in;\n    ",e})),m(this,"createModalContentElement",(()=>{const e=document.createElement("div");return e.id="truelayer-modal-content",e.style.cssText=`\n      box-sizing: border-box;\n      background-color: white;\n      border-radius: 5px;\n      padding: 0;\n      margin: auto;\n      border: 0px transparent;\n      width: ${this.environment.width};\n      height: ${this.environment.height};\n      overflow: hidden;\n      opacity: 0;\n      transform: scale(0.8);\n      transform-origin: center center;\n      transition: all 0.4s ease-in;\n      box-shadow: 0 0 0 1px rgb(17 20 24 / 10%), 0 2px 4px rgb(17 20 24 / 20%), 0 8px 24px rgb(17 20 24 / 20%);\n    `,e})),m(this,"mount",(()=>(this.logger.log("modal appended to the DOM"),document.body.appendChild(this.modalElement),setTimeout((()=>{this.modalElement.style.opacity="1",this.modalContent.style.opacity="1",this.modalContent.style.transform="scale(1)"}),50),this.setBodyStyle(),this.setModalStyle(),window.addEventListener("resize",this.setModalStyle),this))),m(this,"unmount",(()=>{this.modalElement.style.transition="all 0.2s ease-out",this.modalElement.style.opacity="0",this.modalContent.style.transition="all 0.2s ease-out",this.modalContent.innerHTML="",this.modalContent.style.opacity="0",this.modalContent.style.transform="scale(0.9)",setTimeout((()=>{this.logger.log("modal removed from the DOM"),this.modalElement.remove(),this.resetBodyStyle()}),200),window.removeEventListener("resize",this.setModalStyle)})),m(this,"setModalStyle",(()=>{(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth)<=640?(this.modalContent.style.height="100%",this.modalContent.style.width="100%",this.modalContent.style.margin="8px"):(this.modalContent.style.height=h,this.modalContent.style.width=l,this.modalContent.style.margin="auto")})),m(this,"setBodyStyle",(()=>{document.body.style.overflow="hidden"})),m(this,"resetBodyStyle",(()=>{document.body.style.overflow="auto"})),this.environment=e,this.logger=t,this.modalElement=this.createModalElement(),this.modalContent=this.createModalContentElement(),this.modalElement.appendChild(this.modalContent)}}var f=Object.defineProperty,p=Object.getOwnPropertySymbols,y=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable,w=(e,t,n)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,v=(e,t)=>{for(var n in t||(t={}))y.call(t,n)&&w(e,n,t[n]);if(p)for(var n of p(t))b.call(t,n)&&w(e,n,t[n]);return e};function E(e,t,n){!function(e,t,n,i){var o;null==(o=e.contentWindow)||o.postMessage(v({type:"[TRUELAYER]",message:t,date:Date.now()},n),i)}(e,"CUSTOM_APPEARANCE",{appearance:t},n)}const _="CLOSE",P="REDIRECT_TO_PROVIDER",O="HPP_READY",x="HPP_DONE",S="HPP_HANDOFF_START",C="HPP_ERROR_DISMISSED",L="CLOSE_BANK_TAB";var R=Object.defineProperty,k=(e,t,n)=>(((e,t,n)=>{t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class U{constructor(e){k(this,"environment"),k(this,"config"),k(this,"iframe"),k(this,"logger"),k(this,"unmount"),k(this,"win",null),k(this,"subscribe",(()=>{this.iframe.addEventListener("load",this.handleIframeLoad),window.addEventListener("message",this.handleEvent)})),k(this,"unsubscribe",(()=>{this.iframe.removeEventListener("load",this.handleIframeLoad),window.removeEventListener("message",this.handleEvent)})),k(this,"handleIframeLoad",(()=>{this.logger.log("hosted payment page loaded"),this.config.onLoad&&(this.logger.log("executing onLoad callback"),this.config.onLoad())})),k(this,"handHandoffStart",(()=>{this.logger.log("hosted payment page start handoff"),this.config.onHandoffStart&&(this.logger.log("executing onHandoffStart callback"),this.config.onHandoffStart())})),k(this,"handleEvent",(e=>{const t=e.data;if(e.origin===this.environment.hppUrl)if(e.data)if("[TRUELAYER]"===t.type)try{this.logger.info("event received",t.message,e),this.handleMessage(t)}catch(e){this.logger.error("error in message",e),this.config.onError&&this.config.onError(e)}else this.logger.error("data type not equal to [TRUELAYER]");else this.logger.error("unknown data in message",e);else this.logger.error("unknown origin",e)})),k(this,"handleMessage",(e=>{var t,n;switch(e.message){case x:return void this.handleDone();case S:return void this.handHandoffStart();case _:return void this.handleClose();case O:return void this.handleHppReady();case P:const i=this.validateURL(e.provider_uri);return void(i&&(!0===this.config.open_bank_in_new_tab?(this.win=window.open(i,"_blank"),null==(t=this.win)||t.focus(),this.config.onOpenBankInNewTab&&this.config.onOpenBankInNewTab()):window.location.href=i));case C:return void this.handleErrorDismiss();case L:return void(null==(n=this.win)||n.close());default:return void this.logger.log("Unknown message type")}})),k(this,"handleClose",(()=>{this.cleanUp(),this.config.onAbort&&(this.logger.log("executing onAbort callback"),this.config.onAbort(this.config.target))})),k(this,"handleErrorDismiss",(()=>{this.cleanUp(),this.config.onErrorDismiss&&(this.logger.log("executing onErrorDismiss callback"),this.config.onErrorDismiss(this.config.target))})),k(this,"handleDone",(()=>{this.cleanUp(),this.config.onDone&&(this.logger.log("executing onDone callback"),this.config.onDone(this.config.target))})),k(this,"handleHppReady",(()=>{var e;E(this.iframe,null!=(e=this.config.appearance)?e:{},this.environment.hppUrl)})),k(this,"cleanUp",(()=>{var e;null==(e=this.win)||e.close(),this.unmount&&this.unmount(),this.unsubscribe(),this.logger.log("cleaned up")})),k(this,"validateURL",(e=>{const t=this.config.production?"https://payment.truelayer.com":"https://payment.truelayer-sandbox.com";if(t){const n=new URL(t),i=new URL(e);if(n.origin===i.origin)return e}return e.startsWith("https")?e:(this.logger.log("uri is not valid",e),this.config.onError&&this.config.onError(new Error(`uri is not valid, received: ${e}`)),void this.cleanUp())})),this.environment=e.environment,this.config=e.config,this.iframe=e.hppClient.getIframe(),this.logger=e.logger,this.unmount=e.unmount}}const D=()=>{};function I(e){return"undefined"!=typeof window&&e?{log:H(window.console.log),warn:H(window.console.warn),info:H(window.console.info),error:H(window.console.error)}:{log:D,warn:D,info:D,error:D}}function H(e){const t="[SDK]";return(...n)=>{1===n.length&&"string"==typeof n[0]?e(`${t} ${n[0]}`):e(t,...n)}}var T=Object.defineProperty,j=Object.defineProperties,M=Object.getOwnPropertyDescriptors,A=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable,N=(e,t,n)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,W=(e,t)=>{for(var n in t||(t={}))$.call(t,n)&&N(e,n,t[n]);if(A)for(var n of A(t))B.call(t,n)&&N(e,n,t[n]);return e},z=(e,t)=>j(e,M(t));function q(e){if(!e)throw new Error("config is required");let t,n=I(e.debug_mode);return n.log("configured with",e),{start:i=>{const o=W(W({},e),i);n=I(o.debug_mode);try{n.log("started with",o),t=function(e,t){const n=function(e){const t=e.production?"https://payment.truelayer.com":"https://payment.truelayer-sandbox.com";if(!t)throw new Error("EPP version or HPP url missing");return{hppUrl:t,version:"0.2.25",mock:"true"==="undefined".toLowerCase(),width:l,height:h,minWidth:d,minHeight:c}}(e);let i,o=e.target;if(!o){const e=new u(n,t);o=e.mount().modalContent,i=e.unmount}const r=new a(n,e,t);r.attachIframe(o);const s=new U({environment:n,config:e,hppClient:r,logger:t,unmount:i});return s.subscribe(),s.unsubscribe}(o,n)}catch(e){n.log("error",e),o.onError&&o.onError(e)}},unmount:()=>{if(t)try{n.log("unmount called"),t()}catch(e){n.log("error on unmount",e)}}}}e.Mandate=function(e){return q(z(W({},e),{type:"mandate"}))},e.Payment=function(e){return q(z(W({},e),{type:"payment"}))},Object.defineProperty(e,"__esModule",{value:!0})}));
