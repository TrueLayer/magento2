var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,o=(t,n,i)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i,r=(e,t,n)=>(o(e,"symbol"!=typeof t?t+"":t,n),n);class s{constructor(e,s,a){r(this,"config"),r(this,"environment"),r(this,"logger"),r(this,"iframe"),r(this,"getIframe",(()=>this.iframe||this.createIframe())),r(this,"createIframe",(()=>(this.iframe=document.createElement("iframe"),this.iframe.src=this.getUrl(),this.iframe.title="Hosted payment page - EPP",this.iframe.style.border="none",this.iframe.style.boxSizing="border-box",this.iframe.style.width="100%",this.iframe.style.height="100%",this.iframe.style.minWidth=this.environment.minWidth,this.iframe.style.minHeight=this.environment.minHeight,this.logger.log("created HPP iframe:",this.iframe.src),this.iframe))),r(this,"attachIframe",(e=>{e.appendChild(this.getIframe()),this.logger.log("attached HPP iframe to:",e)})),r(this,"getUrl",(()=>{var e;const r=new URLSearchParams({lng:this.getLanguage()}),s=((e,r)=>{for(var s in r||(r={}))n.call(r,s)&&o(e,s,r[s]);if(t)for(var s of t(r))i.call(r,s)&&o(e,s,r[s]);return e})({"web-sdk":this.environment.version,signup:String(null!=(e=this.config.signup)&&e),open_bank_in_new_tab:String(!0===this.config.open_bank_in_new_tab),hide_navigation:String(!0===this.config.hide_navigation),max_wait_for_result:this.config.max_wait_for_result,[`${this.config.type}_id`]:this.getResourceId(),resource_token:this.config.resource_token,return_uri:this.config.return_uri,merchant_logo_uri:this.config.merchant_logo_uri},this.config.extra_hash_params),a=JSON.parse(JSON.stringify(s,((e,t)=>null===t||""===t?void 0:t))),l=new URLSearchParams(a),h=new URL(this.getResourcePath(),this.environment.hppUrl);return h.search=r.toString(),h.hash=l.toString(),h.toString()})),r(this,"getResourceId",(()=>{switch(this.config.type){case"payment":return this.config.payment_id;case"mandate":return this.config.mandate_id;default:return""}})),r(this,"getLanguage",(()=>{if(this.config.language){if(!/^[a-z]{2}$/i.test(this.config.language))throw new Error("Language passed in the wrong format. Accepted ISO 2 Letter Language Codes");return this.config.language}return""})),r(this,"getResourcePath",(()=>`${"mandate"===this.config.type?"/mandates":"/payments"}${this.environment.mock?"-mock":""}`)),r(this,"setConfig",(e=>{if("payment"===e.type&&!e.payment_id)throw new Error("payment_id is required");if("mandate"===e.type&&!e.mandate_id)throw new Error("mandate_id is required");if(!e.resource_token)throw new Error("resource_token is required");if(!e.return_uri)throw new Error("return_uri is required");this.config=e})),this.setConfig(s),this.environment=e,this.logger=a}}const a="600px",l="750px",h="320px",c="320px";var d=Object.defineProperty,g=(e,t,n)=>(((e,t,n)=>{t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class m{constructor(e,t){g(this,"environment"),g(this,"logger"),g(this,"modalElement"),g(this,"modalContent"),g(this,"createModalElement",(()=>{const e=document.createElement("div");return e.id="truelayer-modal",e.style.cssText="\n      box-sizing: border-box;\n      position: fixed;\n      display: flex;\n      z-index: 9999;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      margin: auto;\n      background-color: rgb(0,0,0);\n      background-color: rgba(0,0,0,0.6);\n      opacity: 0;\n      transition: all 0.5s ease-in;\n    ",e})),g(this,"createModalContentElement",(()=>{const e=document.createElement("div");return e.id="truelayer-modal-content",e.style.cssText=`\n      box-sizing: border-box;\n      background-color: white;\n      border-radius: 5px;\n      padding: 0;\n      margin: auto;\n      border: 0px transparent;\n      width: ${this.environment.width};\n      height: ${this.environment.height};\n      overflow: hidden;\n      opacity: 0;\n      transform: scale(0.8);\n      transform-origin: center center;\n      transition: all 0.4s ease-in;\n      box-shadow: 0 0 0 1px rgb(17 20 24 / 10%), 0 2px 4px rgb(17 20 24 / 20%), 0 8px 24px rgb(17 20 24 / 20%);\n    `,e})),g(this,"mount",(()=>(this.logger.log("modal appended to the DOM"),document.body.appendChild(this.modalElement),setTimeout((()=>{this.modalElement.style.opacity="1",this.modalContent.style.opacity="1",this.modalContent.style.transform="scale(1)"}),50),this.setBodyStyle(),this.setModalStyle(),window.addEventListener("resize",this.setModalStyle),this))),g(this,"unmount",(()=>{this.modalElement.style.transition="all 0.2s ease-out",this.modalElement.style.opacity="0",this.modalContent.style.transition="all 0.2s ease-out",this.modalContent.innerHTML="",this.modalContent.style.opacity="0",this.modalContent.style.transform="scale(0.9)",setTimeout((()=>{this.logger.log("modal removed from the DOM"),this.modalElement.remove(),this.resetBodyStyle()}),200),window.removeEventListener("resize",this.setModalStyle)})),g(this,"setModalStyle",(()=>{(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth)<=640?(this.modalContent.style.height="100%",this.modalContent.style.width="100%",this.modalContent.style.margin="8px"):(this.modalContent.style.height=l,this.modalContent.style.width=a,this.modalContent.style.margin="auto")})),g(this,"setBodyStyle",(()=>{document.body.style.overflow="hidden"})),g(this,"resetBodyStyle",(()=>{document.body.style.overflow="auto"})),this.environment=e,this.logger=t,this.modalElement=this.createModalElement(),this.modalContent=this.createModalContentElement(),this.modalElement.appendChild(this.modalContent)}}var u=Object.defineProperty,f=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable,w=(e,t,n)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,b=(e,t)=>{for(var n in t||(t={}))p.call(t,n)&&w(e,n,t[n]);if(f)for(var n of f(t))y.call(t,n)&&w(e,n,t[n]);return e};function v(e,t,n){!function(e,t,n,i){var o;null==(o=e.contentWindow)||o.postMessage(b({type:"[TRUELAYER]",message:t,date:Date.now()},n),i)}(e,"CUSTOM_APPEARANCE",{appearance:t},n)}const E="CLOSE",_="REDIRECT_TO_PROVIDER",O="HPP_READY",P="HPP_DONE",S="HPP_HANDOFF_START",x="HPP_ERROR_DISMISSED",C="CLOSE_BANK_TAB";var L=Object.defineProperty,R=(e,t,n)=>(((e,t,n)=>{t in e?L(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class k{constructor(e){R(this,"environment"),R(this,"config"),R(this,"iframe"),R(this,"logger"),R(this,"unmount"),R(this,"win",null),R(this,"subscribe",(()=>{this.iframe.addEventListener("load",this.handleIframeLoad),window.addEventListener("message",this.handleEvent)})),R(this,"unsubscribe",(()=>{this.iframe.removeEventListener("load",this.handleIframeLoad),window.removeEventListener("message",this.handleEvent)})),R(this,"handleIframeLoad",(()=>{this.logger.log("hosted payment page loaded"),this.config.onLoad&&(this.logger.log("executing onLoad callback"),this.config.onLoad())})),R(this,"handHandoffStart",(()=>{this.logger.log("hosted payment page start handoff"),this.config.onHandoffStart&&(this.logger.log("executing onHandoffStart callback"),this.config.onHandoffStart())})),R(this,"handleEvent",(e=>{const t=e.data;if(e.origin===this.environment.hppUrl)if(e.data)if("[TRUELAYER]"===t.type)try{this.logger.info("event received",t.message,e),this.handleMessage(t)}catch(e){this.logger.error("error in message",e),this.config.onError&&this.config.onError(e)}else this.logger.error("data type not equal to [TRUELAYER]");else this.logger.error("unknown data in message",e);else this.logger.error("unknown origin",e)})),R(this,"handleMessage",(e=>{var t,n;switch(e.message){case P:return void this.handleDone();case S:return void this.handHandoffStart();case E:return void this.handleClose();case O:return void this.handleHppReady();case _:const i=this.validateURL(e.provider_uri);return void(i&&(!0===this.config.open_bank_in_new_tab?(this.win=window.open(i,"_blank"),null==(t=this.win)||t.focus(),this.config.onOpenBankInNewTab&&this.config.onOpenBankInNewTab()):window.location.href=i));case x:return void this.handleErrorDismiss();case C:return void(null==(n=this.win)||n.close());default:return void this.logger.log("Unknown message type")}})),R(this,"handleClose",(()=>{this.cleanUp(),this.config.onAbort&&(this.logger.log("executing onAbort callback"),this.config.onAbort(this.config.target))})),R(this,"handleErrorDismiss",(()=>{this.cleanUp(),this.config.onErrorDismiss&&(this.logger.log("executing onErrorDismiss callback"),this.config.onErrorDismiss(this.config.target))})),R(this,"handleDone",(()=>{this.cleanUp(),this.config.onDone&&(this.logger.log("executing onDone callback"),this.config.onDone(this.config.target))})),R(this,"handleHppReady",(()=>{var e;v(this.iframe,null!=(e=this.config.appearance)?e:{},this.environment.hppUrl)})),R(this,"cleanUp",(()=>{var e;null==(e=this.win)||e.close(),this.unmount&&this.unmount(),this.unsubscribe(),this.logger.log("cleaned up")})),R(this,"validateURL",(e=>{const t=this.config.production?"https://payment.truelayer.com":"https://payment.truelayer-sandbox.com";if(t){const n=new URL(t),i=new URL(e);if(n.origin===i.origin)return e}return e.startsWith("https")?e:(this.logger.log("uri is not valid",e),this.config.onError&&this.config.onError(new Error(`uri is not valid, received: ${e}`)),void this.cleanUp())})),this.environment=e.environment,this.config=e.config,this.iframe=e.hppClient.getIframe(),this.logger=e.logger,this.unmount=e.unmount}}const U=()=>{};function D(e){return"undefined"!=typeof window&&e?{log:I(window.console.log),warn:I(window.console.warn),info:I(window.console.info),error:I(window.console.error)}:{log:U,warn:U,info:U,error:U}}function I(e){const t="[SDK]";return(...n)=>{1===n.length&&"string"==typeof n[0]?e(`${t} ${n[0]}`):e(t,...n)}}var H=Object.defineProperty,j=Object.defineProperties,M=Object.getOwnPropertyDescriptors,T=Object.getOwnPropertySymbols,A=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable,B=(e,t,n)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,N=(e,t)=>{for(var n in t||(t={}))A.call(t,n)&&B(e,n,t[n]);if(T)for(var n of T(t))$.call(t,n)&&B(e,n,t[n]);return e},W=(e,t)=>j(e,M(t));function z(e){return Y(W(N({},e),{type:"payment"}))}function q(e){return Y(W(N({},e),{type:"mandate"}))}function Y(e){if(!e)throw new Error("config is required");let t,n=D(e.debug_mode);return n.log("configured with",e),{start:i=>{const o=N(N({},e),i);n=D(o.debug_mode);try{n.log("started with",o),t=function(e,t){const n=function(e){const t=e.production?"https://payment.truelayer.com":"https://payment.truelayer-sandbox.com";if(!t)throw new Error("EPP version or HPP url missing");return{hppUrl:t,version:"0.2.25",mock:"true"==="undefined".toLowerCase(),width:a,height:l,minWidth:h,minHeight:c}}(e);let i,o=e.target;if(!o){const e=new m(n,t);o=e.mount().modalContent,i=e.unmount}const r=new s(n,e,t);r.attachIframe(o);const d=new k({environment:n,config:e,hppClient:r,logger:t,unmount:i});return d.subscribe(),d.unsubscribe}(o,n)}catch(e){n.log("error",e),o.onError&&o.onError(e)}},unmount:()=>{if(t)try{n.log("unmount called"),t()}catch(e){n.log("error on unmount",e)}}}}export{q as Mandate,z as Payment};
